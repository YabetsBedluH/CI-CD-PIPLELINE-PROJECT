name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Stage 1: Build and Test
  build-and-test:
    runs-on: ubuntu-latest  # GitHub-hosted runner
    
    steps:
      # Checkout repository code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # Install dependencies
      - name: Install dependencies
        run: npm ci
      
      # Run automated tests
      - name: Run tests
        run: npm test
      
      # Build Docker image
      - name: Build Docker image
        run: docker build -t contact-manager:${{ github.sha }} .
      
      # Save Docker image as artifact
      - name: Save Docker image
        run: |
          docker save contact-manager:${{ github.sha }} | gzip > contact-manager.tar.gz
      
      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: contact-manager.tar.gz
          retention-days: 1
      
      - name: Build success notification
        run: echo "âœ… Build and test stage completed successfully!"

  # Stage 2: Deploy (Simulated)
  deploy:
    runs-on: ubuntu-latest  # GitHub-hosted runner
    needs: build-and-test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      # Download the built Docker image
      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
      
      # Load Docker image
      - name: Load Docker image
        run: |
          docker load < contact-manager.tar.gz
          docker tag contact-manager:${{ github.sha }} contact-manager:latest
      
      # Deploy container (simulated for demonstration)
      - name: Deploy container
        run: |
          docker run -d -p 3000:3000 --name contact-app contact-manager:latest
          echo "âœ… Container deployed successfully!"
      
      # Verify deployment
      - name: Verify deployment
        run: |
          sleep 5
          curl -f http://localhost:3000/ || (echo "Deployment verification failed" && exit 1)
          echo "âœ… Application is responding correctly!"
          echo "ðŸ“¦ Deployed image: contact-manager:${{ github.sha }}"

  # Stage 3: Notification
  notify:
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy]
    if: always()
    
    steps:
      - name: Pipeline status notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "ðŸŽ‰ CI/CD Pipeline completed successfully!"
            echo "ðŸ“¦ Application build: ${{ github.sha }}"
            echo "ðŸš€ Deployment timestamp: $(date)"
            echo "âœ… All stages passed: Build â†’ Test â†’ Deploy"
          else
            echo "âŒ Pipeline failed. Please check the logs above."
            exit 1
          fi
